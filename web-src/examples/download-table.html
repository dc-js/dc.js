<!DOCTYPE html>
<html lang="en">
  <head>
    <title>dc.js - Downloading Data Table Contents</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" type="text/css" href="../css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="../css/dc.css" />
    <link type="text/css" rel="stylesheet" href="../css/dc-floatleft.css" />
    <style>
      #table td {
        padding-left: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="header"></div>
      <div id="chart-ring-year" style="width: 300px; height: 330px;">
        <div class="reset" style="visibility: hidden;">
          selected: <span class="filter"></span>
          <a href="javascript:yearRingChart.filterAll();dc.redrawAll();"
            >reset</a
          >
        </div>
      </div>
      <div id="chart-hist-spend" style="width: 300px; height: 330px;">
        <div class="reset" style="visibility: hidden;">
          range: <span class="filter"></span>
          <a href="javascript:spendHistChart.filterAll();dc.redrawAll();"
            >reset</a
          >
        </div>
      </div>
      <div id="chart-row-spenders">
        <div class="reset" style="visibility: hidden;">
          selected: <span class="filter"></span>
          <a href="javascript:spenderRowChart.filterAll();dc.redrawAll();"
            >reset</a
          >
        </div>
      </div>
      <!-- not sure why all these styles necessary, not the point of this -->
      <div style="clear: both; margin: 30px; float: left;">
        <div id="table"></div>
        <div id="download-type" style="clear: both; float: left;">
          <div>
            <label
              ><input
                type="radio"
                name="operation"
                value="raw"
                checked="true"
              />&nbsp;all data</label
            >
          </div>
          <div>
            <label
              ><input type="radio" name="operation" value="table" />&nbsp;table
              data</label
            >
          </div>
        </div>
        <div style="float: left;">
          <button class="btn" id="download">download</button>
        </div>
      </div>

      <script type="text/javascript" src="header.js"></script>
      <script type="text/javascript" src="../js/d3.js"></script>
      <script type="text/javascript" src="../js/crossfilter.js"></script>
      <script type="text/javascript" src="../js/dc.js"></script>
      <script type="text/javascript" src="../js/FileSaver.js"></script>
      <script type="text/javascript">
        const chartGroup = new dc.ChartGroup();
        /* global saveAs */

        const yearRingChart = new dc.PieChart('#chart-ring-year', chartGroup),
          spendHistChart = new dc.BarChart('#chart-hist-spend', chartGroup),
          spenderRowChart = new dc.RowChart('#chart-row-spenders', chartGroup);

        const table = new dc.DataTable('#table', chartGroup);

        // use static or load via d3.csv("spendData.csv").then(function(spendData) {/* do stuff */});
        const spendData = [
          { Name: 'Mr A', Spent: '$40', Year: 2011 },
          { Name: 'Mr B', Spent: '$10', Year: 2011 },
          { Name: 'Mr C', Spent: '$40', Year: 2011 },
          { Name: 'Mr A', Spent: '$70', Year: 2012 },
          { Name: 'Mr B', Spent: '$20', Year: 2012 },
          { Name: 'Mr B', Spent: '$50', Year: 2013 },
          { Name: 'Mr C', Spent: '$30', Year: 2013 },
        ];

        // normalize/parse data
        spendData.forEach(d => {
          d.Spent = d.Spent.match(/\d+/)[0];
        });

        // set crossfilter
        const ndx = crossfilter(spendData),
          yearDim = ndx.dimension(d => +d.Year),
          spendDim = ndx.dimension(d => Math.floor(d.Spent / 10)),
          nameDim = ndx.dimension(d => d.Name),
          spendPerYear = yearDim.group().reduceSum(d => +d.Spent),
          spendPerName = nameDim.group().reduceSum(d => +d.Spent),
          spendHist = spendDim.group().reduceCount();

        yearRingChart
          .configure({
            width: 300,
            height: 300,
          })
          .dataProvider(
            new dc.CFSimpleAdapter({
              dimension: yearDim,
              group: spendPerYear,
            })
          )
          .configure({
            innerRadius: 50,
            controlsUseVisibility: true,
          });

        spendHistChart
          .dataProvider(
            new dc.CFMultiAdapter({
              dimension: spendDim,

              layers: [
                {
                  group: spendHist,
                },
              ],
            })
          )
          .configure({
            elasticY: true,
            controlsUseVisibility: true,
          })
          .x(d3.scaleLinear().domain([0, 10]));

        spendHistChart.xAxis().tickFormat(d => d * 10); // convert back to base unit
        spendHistChart.yAxis().ticks(2);

        spenderRowChart
          .dataProvider(
            new dc.CFSimpleAdapter({
              dimension: nameDim,
              group: spendPerName,
            })
          )
          .configure({
            elasticX: true,
            controlsUseVisibility: true,
          });

        const allDollars = ndx.groupAll().reduceSum(d => +d.Spent);

        table
          .dataProvider(
            new dc.CFSimpleAdapter({
              dimension: spendDim,
            })
          )
          .configure({
            sortBy: d => +d.Spent,
            showSections: false,

            columns: [
              'Name',
              {
                label: 'Spent',
                format: function (d) {
                  return `$${d.Spent}`;
                },
              },
              'Year',
              {
                label: 'Percent of Total',
                format: function (d) {
                  return `${Math.floor((d.Spent / allDollars.value()) * 100)}%`;
                },
              },
            ],
          });

        d3.select('#download').on('click', () => {
          let data = nameDim.top(Infinity);
          if (
            d3.select('#download-type input:checked').node().value === 'table'
          ) {
            data = data.sort((a, b) =>
              table.order()(table.sortBy()(a), table.sortBy()(b))
            );
            data = data.map(d => {
              const row = {};
              table.columns().forEach(c => {
                row[
                  table._doColumnHeaderFormat(c)
                ] = table._doColumnValueFormat(c, d);
              });
              return row;
            });
          }
          const blob = new Blob([d3.csvFormat(data)], {
            type: 'text/csv;charset=utf-8',
          });
          saveAs(blob, 'data.csv');
        });

        chartGroup.renderAll();
      </script>
    </div>
  </body>
</html>
